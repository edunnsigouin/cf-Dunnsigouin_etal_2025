"""
Converts era5 yearly files into the same format as ecmwf hindcasts
corresponding to foreacsts initialized on mondays and thursdays for a given year.
e.g., for a forecast initialized on 2021-01-04, we collect all data for years 2001-2020
starting on 01-04 + 15 days (for high-resolution). Analogous files are created for low-resolution
data corresponfing to low-reoslution forecasts.  
"""

import numpy  as np
import xarray as xr
import pandas as pd
from dask.diagnostics   import ProgressBar
import os
from forsikring import config,misc,s2s

def init_hindcast(dim,date,hindcast_years,time,variable,long_name,units):
    """ 
    Initializes output array used below. 
    Written here to clean up code.
    """
    month_day     = date.strftime('%m%d')
    hdate = hindcast_years.astype(int) + month_day

    print(hdate)
    
    data   = np.zeros((time.size,hdate.size,dim.nlatitude,dim.nlongitude),dtype=np.float32)
    dims   = ["time","hdate","latitude","longitude"]
    coords = dict(time=time,hdate=hdate,latitude=dim.latitude,longitude=dim.longitude)
    attrs  = dict(long_name=long_name,units=units)
    output = xr.DataArray(data=data,dims=dims,coords=coords,attrs=attrs,name=variable)
    return output

# INPUT -----------------------------------------------
variables        = ['tp24']             # tp24,rn24,mx24rn6,mx24tp6,mx24tpr
init_start       = '20210104'              # first initialization date of forecast (either a monday or thursday)
init_n           = 1                     # number of forecasts   
grids            = ['0.25x0.25']           # '0.25x0.25' or '0.5x0.5'
comp_lev         = 5
write2file       = False
# -----------------------------------------------------         

# get all dates for monday and thursday forecast initializations 
init_dates = s2s.get_init_dates(init_start,init_n)

for variable in variables:
    for grid in grids:
        for date in init_dates:

            # define stuff
            dim            = s2s.get_dim(grid,'time')
            datestring     = date.strftime('%Y-%m-%d')
            forecast_year  = int(date.strftime('%Y'))
            hindcast_years = np.arange(forecast_year-1-20,forecast_year,1)
            path_in        = config.dirs['era5_cont_daily'] + variable + '/'
            path_out       = config.dirs['era5_hindcast_daily'] + variable + '/'

            filenames_in = [path_in + variable + '_' + grid + '_' + str(hindcast_years[0]) + '.nc']
            for year in hindcast_years[1:]: filenames_in = filenames_in + [path_in + variable + '_' + grid + '_' + str(year) + '.nc']
            da    = xr.open_mfdataset(filenames_in)[variable]

            month_day     = date.strftime('%m%d')
            for i in range(1,hindcast_years.size):
                print(hindcast_years[i].astype(str) + month_day)

            #print(hindcast_years.astype(str) + month_day)
            
#            print(da)
#            print(da.attrs['long_name'])
            
#            hindcast = init_hindcast(dim,date,hindcast_years,da.time,variable,da.attrs['long_name'],da.attrs['units'])            
"""            
            # define some paths and strings
            filename1_in = variable + '_' + grid + '_' + year + '.nc'
            filename2_in = variable + '_' + grid + '_' + str(int(year)+1) + '.nc'
            filename_out = '%s_%s_%s.nc'%(variable,grid,datestring)

            # read data & pick out specific dates (46 = # of days in ecmwf forecast)
            if grid == '0.25x0.25':
                era5_dates = pd.date_range(date,periods=15,freq="D")
            elif grid == '0.5x0.5':
                era5_dates = pd.date_range(date,periods=31,freq="D") + np.timedelta64(15,'D')
            ds = xr.open_mfdataset([path_in + filename1_in,path_in + filename2_in]).sel(time=era5_dates)

            # calculate explicitely
            with ProgressBar():
                ds = ds.compute()

            if write2file:
                print('writing to file..')
                s2s.to_netcdf_pack64bit(ds[variable],path_out + filename_out)
                print('compress file to reduce space..')
                s2s.compress_file(comp_lev,3,filename_out,path_out)
                print('')

            ds.close()
"""
