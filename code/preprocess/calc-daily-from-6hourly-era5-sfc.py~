"""
Calculates daily quantities based off of downloaded 6hourly 
ERA5 data 
"""

import numpy  as np
import xarray as xr
import os
from forsikring import config,misc

# INPUT ----------------------------------------------- 
variables  = ['tp','rn','mxtpr','mxtp6','mxrn6']
years      = np.arange(1995,2022,1)
grid       = '0.5/0.5' # '0.25/0.25' or '0.5/0.5'
comp_lev   = 5
write2file = True
# -----------------------------------------------------            

for variable in variables:
    for year in years:
        
        misc.tic()
        print('variable: ' + variable + ', year: ' + str(year))

        if grid == '0.25/0.25':
            path_in  = config.dirs['era5_6hourly'] + '/0.25x0.25/'
            path_out = config.dirs['era5_daily'] + '/0.25x0.25/'
        elif grid == '0.5/0.5':
            path_in  = config.dirs['era5_6hourly'] + '/0.5x0.5/' 
            path_out = config.dirs['era5_daily'] + '/0.5x0.5/'
            
        if variable == 'tp': # daily accumulated precip (m)
            dir_in                    = path_in + variable + '/'
            dir_out                   = path_out + variable + '/'
            filename_in               = variable + '_' + str(year) + '.nc'
            filename_out              = variable + '_' + str(year) + '.nc'
            ds                        = xr.open_dataset(dir_in + filename_in)
            ds                        = ds.resample(time='1D').sum('time')
            ds.tp.attrs['units']      = 'm'
            ds.tp.attrs['long_name']  = 'daily accumulated precipitation'
            if write2file:
                ds.to_netcdf(dir_out + filename_out)
            ds.close()
            
        elif variable == 'rn': # daily accumulated rain (precip - snowfall, m)
            dir_in1      = path_in + 'tp/'
            dir_in2      = path_in + 'sf/'
            dir_out      = path_out + variable + '/'
            filename1_in = 'tp_' + str(year) + '.nc'
            filename2_in = 'sf_' + str(year) + '.nc'
            ds1          = xr.open_dataset(dir_in1 + filename1_in)
            ds2          = xr.open_dataset(dir_in2 + filename2_in)
            ds1          = ds1.resample(time='1D').sum('time')
            ds2          = ds2.resample(time='1D').sum('time')
            ds1['tp']    = ds1['tp'] - ds2['sf']
            if write2file:
                filename_out              = 'rn_' + str(year) + '.nc'
                ds1                       = ds1.rename({'tp':'rn'})
                ds1.rn.attrs['units']     = 'm'
                ds1.rn.attrs['long_name'] = 'daily accumulated rainfall'
                ds1.to_netcdf(dir_out + filename_out)
            ds1.close()
            ds2.close()
            
        elif variable == 'mxtp6': # daily maximum 6 hour accumulated precip (m)
            dir_in                    = path_in + 'tp/'
            dir_out                   = path_out + variable + '/'
            filename_in               = 'tp_' + str(year) + '.nc'
            filename_out              =	variable + '_' + str(year) + '.nc'
            ds                        = xr.open_dataset(dir_in + filename_in)
            ds                        = ds.resample(time='1D').max('time')
            ds.tp.attrs['units']      = 'm'
            ds.tp.attrs['long_name']  = 'daily maximum 6 hour accumulated precipitation'
            if write2file:
                ds.to_netcdf(dir_out + filename_out)
            ds.close()

        elif variable == 'mxtpr': # daily maximum timestep precipitation rate (kgm-2s-1)
            dir_in                      = path_in + variable + '/'
            dir_out                     = path_out + variable + '/'
            filename_in                 = variable + '_' + str(year) + '.nc'
            filename_out                = variable + '_' + str(year) + '.nc'
            ds                          = xr.open_dataset(dir_in + filename_in)
            ds                          = ds.resample(time='1D').max('time')
            ds.mxtpr.attrs['units']     = 'kg m**-2 s**-1'
            ds.mxtpr.attrs['long_name'] = 'daily maximum timestep precipitation rate'
            if write2file:
                ds.to_netcdf(dir_out + filename_out)
            ds.close()
            
        elif variable == 'mxrn6': # daily maximum 6 hour accumulated rain (precip - snowfall, m)
            dir_in1      = path_in + 'tp/'
            dir_in2      = path_in + 'sf/'
            dir_out      = path_out + variable + '/'
            filename1_in = 'tp_' + str(year) + '.nc'
            filename2_in = 'sf_' + str(year) + '.nc'
            ds1          = xr.open_dataset(dir_in1 + filename1_in)
            ds2          = xr.open_dataset(dir_in2 + filename2_in)
            da           = (ds1['tp'] - ds2['sf']).resample(time='1D').max('time')
            if write2file:
                filename_out             = variable + '_' + str(year) + '.nc'
                da.name                  = variable
                da.attrs['units']        = 'm'
                da.attrs['long_name']    = 'daily maximum 6 hour accumulated rainfall'
                da.to_netcdf(dir_out + filename_out)
            ds1.close()
            ds2.close()
            da.close()
            
        print('compress file to reduce space..')
        cmd               = 'nccopy -k 3 -s -d ' + str(comp_lev) + ' '
        filename_out_comp = 'compressed_' + variable + '_' + str(year) + '.nc'
        os.system(cmd + dir_out + filename_out + ' ' + dir_out + filename_out_comp)
        os.system('mv ' + dir_out + filename_out_comp + ' ' + dir_out + filename_out)
        
        misc.toc()
